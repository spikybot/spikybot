#!/bin/bash

# SpikyBot çµ±åˆã‚³ãƒãƒ³ãƒ‰

# Slack APIå…±é€šé–¢æ•°
slack_api_call() {
  local method="$1"
  local params="$2"
  
  if [ -z "$SLACK_BOT_TOKEN" ]; then
    echo "Error: SLACK_BOT_TOKENç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    return 1
  fi
  
  curl -s -X GET \
    -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    "https://slack.com/api/${method}?${params}"
}

SUBCOMMAND="$1"
shift

case "$SUBCOMMAND" in
  comment)
    # sb-commentã®æ©Ÿèƒ½ã‚’çµ±åˆ
    FINALIZE=false
    MESSAGE=""
    
    while [[ $# -gt 0 ]]; do
      case $1 in
        --finalize)
          FINALIZE=true
          shift
          ;;
        *)
          MESSAGE="$*"
          break
          ;;
      esac
    done
    
    if [ -z "$MESSAGE" ]; then
      echo "Usage: sb comment [--finalize] 'message'"
      exit 1
    fi
    
    if [ "$FINALIZE" = true ]; then
      FINAL_MESSAGE="@$GITHUB_ACTOR $MESSAGE"
      gh issue comment "$SESSION_NUMBER" --body "$FINAL_MESSAGE"
    else
      if [ -n "$AGENT_INITIAL_COMMENT_ID" ]; then
        CURRENT_BODY=$(gh api repos/$GITHUB_REPOSITORY/issues/comments/$AGENT_INITIAL_COMMENT_ID --jq '.body' 2>/dev/null || echo "")
        CURRENT_TIME="[$(date '+%Y-%m-%d %H:%M:%S')]"
        if [ -n "$CURRENT_BODY" ]; then
          NEW_BODY="$CURRENT_BODY

$CURRENT_TIME $MESSAGE"
        else
          NEW_BODY="$CURRENT_TIME $MESSAGE"
        fi
        gh issue comment "$SESSION_NUMBER" --edit "$AGENT_INITIAL_COMMENT_ID" --body "$NEW_BODY"
      else
        gh issue comment "$SESSION_NUMBER" --body "$MESSAGE"
      fi
    fi
    ;;
    
  pr)
    # sb-prã®æ©Ÿèƒ½ã‚’çµ±åˆ
    TITLE="$1"
    BODY="$2"
    
    if [ -z "$TITLE" ] || [ -z "$BODY" ]; then
      echo "Usage: sb pr 'title' 'body'"
      exit 1
    fi
    
    if [ "$EVENT_NAME" = "pull_request" ]; then
      echo "PRã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ãŸã‚ã€PR #$SESSION_NUMBER ã‚’æ›´æ–°ã—ã¾ã™"
      gh pr edit "$SESSION_NUMBER" --title "$TITLE" --body "$BODY"
    else
      EXISTING_PR=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' 2>/dev/null)
      if [ -n "$EXISTING_PR" ]; then
        echo "æ—¢å­˜ã®PR #$EXISTING_PR ã‚’æ›´æ–°ã—ã¾ã™"
        gh pr edit "$EXISTING_PR" --title "$TITLE" --body "$BODY"
      else
        echo "æ–°è¦PRã‚’ä½œæˆã—ã¾ã™"
        PR_OUTPUT=$(gh pr create --title "$TITLE" --body "$BODY" --assignee "@me" 2>&1)
        PR_NUMBER=$(echo "$PR_OUTPUT" | grep -o 'pull/[0-9]*' | sed 's/pull\///')
        echo "$PR_OUTPUT"
        if [ -n "$PR_NUMBER" ]; then
          echo "LATEST_PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"
        fi
      fi
    fi
    ;;
    
  status)
    # çµ±åˆçŠ¶æ…‹ç¢ºèª
    echo "=== SpikyBot Status ==="
    echo "Session: $EVENT_NAME #$SESSION_NUMBER"
    echo "Branch: $(git branch --show-current)"
    echo "Latest PR: ${LATEST_PR_NUMBER:-none}"
    echo ""
    echo "=== Recent Comments ==="
    gh issue view "$SESSION_NUMBER" --json comments --jq '.comments[-3:] | .[] | "[\(.author.login)] \(.body)" | .[0:100]' 2>/dev/null || echo "No comments"
    echo ""
    echo "=== Git Status ==="
    git status --short
    ;;
    
  git)
    # Gitæ“ä½œã®ãƒ©ãƒƒãƒ‘ãƒ¼
    GIT_CMD="$1"
    shift
    
    case "$GIT_CMD" in
      add)
        if [ $# -eq 0 ]; then
          echo "Error: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
          echo "Usage: sb git add <filename>"
          exit 1
        fi
        for arg in "$@"; do
          if [[ "$arg" == "." ]] || [[ "$arg" == "-A" ]] || [[ "$arg" == "--all" ]]; then
            echo "Error: '$arg' ã¯ä½¿ç”¨ç¦æ­¢ã§ã™"
            exit 1
          fi
        done
        /usr/bin/git add "$@"
        ;;
        
      push)
        CURRENT_BRANCH=$(/usr/bin/git branch --show-current)
        if [[ ! "$CURRENT_BRANCH" =~ ^spikybot/ ]]; then
          echo "Error: spikybot/*ãƒ–ãƒ©ãƒ³ãƒã®ã¿pushå¯èƒ½ã§ã™"
          exit 1
        fi
        if [ $# -eq 0 ]; then
          /usr/bin/git push origin "$CURRENT_BRANCH"
        else
          /usr/bin/git push "$@"
        fi
        ;;
        
      *)
        # ãã®ä»–ã®gitã‚³ãƒãƒ³ãƒ‰ã¯è¨±å¯
        /usr/bin/git "$GIT_CMD" "$@"
        ;;
    esac
    ;;
    
  continue)
    # ç¶™ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³æº–å‚™ï¼ˆæ—§sb-continueï¼‰
    SITUATION="$1"
    shift
    COMMAND="$*"
    
    if [ -z "$SITUATION" ] || [ -z "$COMMAND" ]; then
      echo "Usage: sb continue 'situation' 'command'"
      exit 1
    fi
    
    # ç¶™ç¶šã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
    cat > "$SB_DIR/continue.sh" << SCRIPT
#!/bin/bash
$COMMAND
SCRIPT
    chmod +x "$SB_DIR/continue.sh"
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç¶™ç¶šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    cat > "$SB_DIR/prompt-continue.txt" << PROMPT
$SITUATION
å†é–‹æ™‚ã«å®Ÿè¡Œã™ã¹ãã‚³ãƒãƒ³ãƒ‰: $COMMAND
PROMPT
    echo "ç¶™ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æº–å‚™ã—ã¾ã—ãŸ"
    ;;
    
  debug)
    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±åé›†ï¼ˆæ—§sb-debugï¼‰
    echo "=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ==="
    echo "Node: $(node --version 2>/dev/null || echo 'not installed')"
    echo "NPM: $(npm --version 2>/dev/null || echo 'not installed')"
    echo "Git: $(git --version)"
    echo "PWD: $(pwd)"
    echo "Branch: $(git branch --show-current 2>/dev/null || echo 'not in git repo')"
    echo "Session: $EVENT_NAME #$SESSION_NUMBER"
    echo "Files:"
    ls -la
    echo ""
    echo "Git Status:"
    git status 2>/dev/null || echo 'not in git repo'
    ;;
    
  knowledge-list)
    # Canvasä¸€è¦§å–å¾—
    echo "=== Slack Canvasä¸€è¦§ ==="
    
    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    echo "Debug: SLACK_BOT_TOKENè¨­å®šçŠ¶æ³: ${SLACK_BOT_TOKEN:+è¨­å®šæ¸ˆã¿}${SLACK_BOT_TOKEN:-æœªè¨­å®š}"
    echo "Debug: ãƒˆãƒ¼ã‚¯ãƒ³å…ˆé ­4æ–‡å­—: ${SLACK_BOT_TOKEN:0:4}***"
    
    # Slack APIçµŒç”±ã§Canvasä¸€è¦§ã‚’å–å¾—
    RESPONSE=$(slack_api_call "files.list" "types=canvas&count=100")
    CURL_EXIT_CODE=$?
    
    echo "Debug: curlçµ‚äº†ã‚³ãƒ¼ãƒ‰: $CURL_EXIT_CODE"
    echo "Debug: ãƒ¬ã‚¹ãƒãƒ³ã‚¹é•·: ${#RESPONSE}"
    
    if [ $CURL_EXIT_CODE -ne 0 ]; then
      echo "Error: Slack APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ (curlçµ‚äº†ã‚³ãƒ¼ãƒ‰: $CURL_EXIT_CODE)"
      exit 1
    fi
    
    # APIå‘¼ã³å‡ºã—çµæœã‚’ãã®ã¾ã¾å‡ºåŠ›ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰
    echo "=== API Response ==="
    echo "$RESPONSE" | jq '.' 2>/dev/null
    
    # jqãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ä»£æ›¿
    if [ $? -ne 0 ]; then
      echo "Raw Response (jq not available):"
      echo "$RESPONSE"
    fi
    ;;
    
  knowledge-view)
    # Canvaså†…å®¹è¡¨ç¤º
    CANVAS_ID="$1"
    
    if [ -z "$CANVAS_ID" ]; then
      echo "Usage: sb knowledge-view <canvas_id>"
      echo "  canvas_id: Canvas file ID (e.g., F1234567890)"
      exit 1
    fi
    
    echo "=== Canvaså†…å®¹è¡¨ç¤º: $CANVAS_ID ==="
    
    # Canvasæƒ…å ±ã‚’å–å¾—
    RESPONSE=$(slack_api_call "files.info" "file=${CANVAS_ID}")
    CURL_EXIT_CODE=$?
    
    if [ $CURL_EXIT_CODE -ne 0 ]; then
      echo "Error: Canvasæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
      exit 1
    fi
    
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
    OK_STATUS=$(echo "$RESPONSE" | jq -r '.ok' 2>/dev/null)
    if [ "$OK_STATUS" != "true" ]; then
      echo "Error: Canvaså–å¾—ã‚¨ãƒ©ãƒ¼"
      echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
      exit 1
    fi
    
    # Canvasæƒ…å ±ã‚’è¡¨ç¤º
    echo "$RESPONSE" | jq '{
      id: .file.id,
      name: .file.name,
      title: .file.title,
      created: .file.created,
      user: .file.user,
      permalink: .file.permalink
    }' 2>/dev/null || echo "$RESPONSE"
    ;;
    
  knowledge-append)
    # Canvaså†…å®¹è¿½è¨˜
    CANVAS_ID="$1"
    CONTENT="$2"
    
    if [ -z "$CANVAS_ID" ] || [ -z "$CONTENT" ]; then
      echo "Usage: sb knowledge-append <canvas_id> 'markdown_content'"
      echo "  canvas_id: Canvas file ID (e.g., F1234567890)"
      echo "  markdown_content: è¿½è¨˜ã™ã‚‹ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å†…å®¹"
      exit 1
    fi
    
    echo "=== Canvaså†…å®¹è¿½è¨˜: $CANVAS_ID ==="
    
    # ç¾åœ¨ã®æ™‚åˆ»ã‚’å–å¾—
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    
    # è¿½è¨˜å†…å®¹ã‚’æº–å‚™ï¼ˆæ”¹è¡Œã‚’å«ã‚€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ï¼‰
    APPEND_CONTENT="

---
## ğŸ“ è¿½è¨˜ ($TIMESTAMP)

$CONTENT
"
    
    # Canvasç·¨é›†APIå‘¼ã³å‡ºã—ç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æº–å‚™
    # URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ãªãŸã‚curlã§ç›´æ¥POST
    curl -s -X POST \
      -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
      -H "Content-Type: application/x-www-form-urlencoded" \
      --data-urlencode "canvas_id=$CANVAS_ID" \
      --data-urlencode "changes=[{\"operation\": \"document_append\", \"args\": {\"content\": \"$APPEND_CONTENT\"}}]" \
      "https://slack.com/api/canvases.edit" | jq '.' 2>/dev/null
    
    if [ $? -eq 0 ]; then
      echo "Canvaså†…å®¹ã‚’è¿½è¨˜ã—ã¾ã—ãŸ"
    else
      echo "Error: Canvasè¿½è¨˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
      exit 1
    fi
    ;;
    
  help|--help|-h|"")
    echo "SpikyBot - GitHub Actions AI Assistant"
    echo ""
    echo "Usage: sb <command> [options]"
    echo ""
    echo "Commands:"
    echo "  comment [--finalize] 'message'  - Post/update comment"
    echo "  pr 'title' 'body'              - Create/update PR"
    echo "  status                         - Show current status"
    echo "  git <git-command>              - Safe git operations"
    echo "  continue 'situation' 'command'  - Prepare continuation session"
    echo "  debug                          - Show debug information"
    echo "  knowledge-list                 - List Slack Canvas knowledge base"
    echo "  knowledge-view <id>            - View Canvas content"
    echo "  knowledge-append <id> 'content' - Append to Canvas"
    echo ""
    echo "Examples:"
    echo "  sb comment 'ä½œæ¥­ã‚’é–‹å§‹ã—ã¾ã—ãŸ'"
    echo "  sb comment --finalize 'ä½œæ¥­å®Œäº†'"
    echo "  sb pr 'Fix bug' 'Fixed the issue'"
    echo "  sb git add README.md"
    echo "  sb git commit -m 'Update README'"
    echo "  sb git push"
    echo "  sb continue 'npm installä¸­' 'npm install'"
    echo "  sb debug"
    echo "  sb knowledge-list"
    echo "  sb knowledge-view F1234567890"
    echo "  sb knowledge-append F1234567890 '## Bug Fix\\n- Issue #123ã‚’ä¿®æ­£'"
    ;;
    
  *)
    echo "Unknown command: $SUBCOMMAND"
    echo "Run 'sb help' for usage"
    exit 1
    ;;
esac