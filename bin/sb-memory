#!/bin/bash

# SpikyBot Memoryæ“ä½œã‚³ãƒãƒ³ãƒ‰ - CanvasçŸ¥è­˜æ°¸ç¶šåŒ–

# Slack APIå…±é€šé–¢æ•°
slack_api_call() {
  local method="$1"
  local params="$2"
  
  if [ -z "$SLACK_BOT_TOKEN" ]; then
    echo "Error: SLACK_BOT_TOKENç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    return 1
  fi
  
  curl -s -X GET \
    -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    "https://slack.com/api/${method}?${params}"
}

SUBCOMMAND="$1"
shift

case "$SUBCOMMAND" in
  list)
    # Canvasä¸€è¦§å–å¾—
    SEARCH_QUERY="$1"
    
    if [ -n "$SEARCH_QUERY" ]; then
      echo "=== Slack Canvasæ¤œç´¢: '$SEARCH_QUERY' ==="
    else
      echo "=== Slack Canvasä¸€è¦§ ==="
    fi
    
    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    echo "Debug: SLACK_BOT_TOKENè¨­å®šçŠ¶æ³: ${SLACK_BOT_TOKEN:+è¨­å®šæ¸ˆã¿}${SLACK_BOT_TOKEN:-æœªè¨­å®š}"
    echo "Debug: ãƒˆãƒ¼ã‚¯ãƒ³å…ˆé ­4æ–‡å­—: ${SLACK_BOT_TOKEN:0:4}***"
    
    # Slack APIçµŒç”±ã§Canvasä¸€è¦§ã‚’å–å¾—ï¼ˆæ¤œç´¢ã‚¯ã‚¨ãƒªãŒã‚ã‚‹å ´åˆã¯æ¤œç´¢ï¼‰
    if [ -n "$SEARCH_QUERY" ]; then
      # æ¤œç´¢APIã‚’ä½¿ç”¨
      RESPONSE=$(slack_api_call "files.list" "types=canvas&count=200&query=${SEARCH_QUERY}")
    else
      # é€šå¸¸ã®ãƒªã‚¹ãƒˆå–å¾—
      RESPONSE=$(slack_api_call "files.list" "types=canvas&count=200&show_files_hidden_by_limit=true")
    fi
    CURL_EXIT_CODE=$?
    
    echo "Debug: curlçµ‚äº†ã‚³ãƒ¼ãƒ‰: $CURL_EXIT_CODE"
    echo "Debug: ãƒ¬ã‚¹ãƒãƒ³ã‚¹é•·: ${#RESPONSE}"
    
    if [ $CURL_EXIT_CODE -ne 0 ]; then
      echo "Error: Slack APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ (curlçµ‚äº†ã‚³ãƒ¼ãƒ‰: $CURL_EXIT_CODE)"
      exit 1
    fi
    
    # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è§£æ
    OK_STATUS=$(echo "$RESPONSE" | jq -r '.ok' 2>/dev/null)
    if [ "$OK_STATUS" != "true" ]; then
      echo "Error: Canvasä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
      echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
      exit 1
    fi
    
    # Canvasä¸€è¦§ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
    echo "=== Canvasä¸€è¦§ ==="
    echo "$RESPONSE" | jq -r '.files[] | "- ID: \(.id)\n  åå‰: \(.name // .title // "ç„¡é¡Œ")\n  ä½œæˆæ—¥: \(.created)\n  URL: \(.permalink)\n"' 2>/dev/null
    
    # ç·æ•°ã¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°æƒ…å ±ã‚’è¡¨ç¤º
    TOTAL_COUNT=$(echo "$RESPONSE" | jq '.files | length' 2>/dev/null || echo "0")
    echo "åˆè¨ˆ: ${TOTAL_COUNT}å€‹ã®Canvas"
    
    # ãƒšãƒ¼ã‚¸ãƒ³ã‚°æƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤º
    HAS_MORE=$(echo "$RESPONSE" | jq -r '.has_more // false' 2>/dev/null)
    if [ "$HAS_MORE" = "true" ]; then
      echo "æ³¨æ„: ã•ã‚‰ã«å¤šãã®CanvasãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
    fi
    
    # ãƒ‡ãƒãƒƒã‚°: æ¨©é™æƒ…å ±
    echo ""
    echo "=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ==="
    echo "ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¹ã‚³ãƒ¼ãƒ—ã§è¡¨ç¤ºå¯èƒ½ãªCanvasã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™"
    echo "ã‚‚ã—æœŸå¾…ã™ã‚‹CanvasãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆ:"
    echo "1. CanvasãŒå­˜åœ¨ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«ã«BotãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
    echo "2. CanvasåãŒæ­£ã—ã„ã‹ç¢ºèªï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã€ã‚¹ãƒšãƒ¼ã‚¹ç­‰ï¼‰"
    ;;
    
  view)
    # Canvaså†…å®¹è¡¨ç¤º
    CANVAS_ID="$1"
    
    if [ -z "$CANVAS_ID" ]; then
      echo "Usage: sb-memory view <canvas_id>"
      echo "  canvas_id: Canvas file ID (e.g., F1234567890)"
      exit 1
    fi
    
    echo "=== Canvaså†…å®¹è¡¨ç¤º: $CANVAS_ID ==="
    
    # Canvasæƒ…å ±ã‚’å–å¾—
    RESPONSE=$(slack_api_call "files.info" "file=${CANVAS_ID}")
    CURL_EXIT_CODE=$?
    
    if [ $CURL_EXIT_CODE -ne 0 ]; then
      echo "Error: Canvasæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
      exit 1
    fi
    
    # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
    OK_STATUS=$(echo "$RESPONSE" | jq -r '.ok' 2>/dev/null)
    if [ "$OK_STATUS" != "true" ]; then
      echo "Error: Canvaså–å¾—ã‚¨ãƒ©ãƒ¼"
      echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
      exit 1
    fi
    
    # Canvasæƒ…å ±ã‚’è¡¨ç¤º
    echo "=== Canvasæƒ…å ± ==="
    echo "$RESPONSE" | jq '{
      id: .file.id,
      name: .file.name,
      title: .file.title,
      created: .file.created,
      user: .file.user,
      permalink: .file.permalink
    }' 2>/dev/null || echo "$RESPONSE"
    
    # Canvaså†…å®¹ã‚’å–å¾—ï¼ˆdocument_contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèªï¼‰
    echo ""
    echo "=== Canvaså†…å®¹ ==="
    
    # document_contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
    DOCUMENT_CONTENT=$(echo "$RESPONSE" | jq -r '.file.document_content // empty' 2>/dev/null)
    
    if [ -n "$DOCUMENT_CONTENT" ]; then
      # document_contentãŒå­˜åœ¨ã™ã‚‹å ´åˆ
      CONTENT_TYPE=$(echo "$DOCUMENT_CONTENT" | jq -r '.type // empty' 2>/dev/null)
      if [ "$CONTENT_TYPE" = "markdown" ]; then
        # Markdownå†…å®¹ã‚’è¡¨ç¤º
        echo "Canvaså†…å®¹ï¼ˆMarkdownå½¢å¼ï¼‰:"
        echo "$DOCUMENT_CONTENT" | jq -r '.markdown // empty' 2>/dev/null
      else
        echo "Canvaså†…å®¹ï¼ˆå½¢å¼: $CONTENT_TYPEï¼‰:"
        echo "$DOCUMENT_CONTENT" | jq '.' 2>/dev/null
      fi
    else
      # document_contentãŒå­˜åœ¨ã—ãªã„å ´åˆ
      echo "document_contentãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚"
      echo ""
      echo "åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:"
      echo "$RESPONSE" | jq '.file | keys' 2>/dev/null | head -20
    fi
    ;;
    
  save)
    # Canvaså†…å®¹è¿½è¨˜
    CANVAS_ID="$1"
    CONTENT="$2"
    
    if [ -z "$CANVAS_ID" ] || [ -z "$CONTENT" ]; then
      echo "Usage: sb-memory save <canvas_id> 'markdown_content'"
      echo "  canvas_id: Canvas file ID (e.g., F1234567890)"
      echo "  markdown_content: è¿½è¨˜ã™ã‚‹ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å†…å®¹"
      exit 1
    fi
    
    echo "=== Canvaså†…å®¹è¿½è¨˜: $CANVAS_ID ==="
    
    # Canvasæƒ…å ±ã‚’å–å¾—ã—ã¦åå‰ã‚’ç¢ºèª
    CANVAS_INFO=$(slack_api_call "files.info" "file=${CANVAS_ID}")
    if [ $? -ne 0 ]; then
      echo "Error: Canvasæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
      exit 1
    fi
    
    # Canvasåã‚’å–å¾— (name, title, ã¾ãŸã¯ filename ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰)
    CANVAS_NAME=$(echo "$CANVAS_INFO" | jq -r '.file.name // .file.title // .file.filename // ""' 2>/dev/null)
    
    # SpikyBot/ã¾ãŸã¯SpikyBot_ã§å§‹ã¾ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if [[ ! "$CANVAS_NAME" =~ ^SpikyBot[/_] ]]; then
      echo "Error: 'SpikyBot/'ã¾ãŸã¯'SpikyBot_'ã§å§‹ã¾ã‚‹Canvasä»¥å¤–ã¸ã®è¿½è¨˜ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“"
      echo "Canvaså: $CANVAS_NAME"
      echo "è¨±å¯ã•ã‚Œã‚‹Canvasåã®ä¾‹: SpikyBot/KnowledgeBase, SpikyBot_Debug_Notes"
      exit 1
    fi
    
    echo "Canvaså: $CANVAS_NAME (è¿½è¨˜è¨±å¯)"
    
    # ç¾åœ¨ã®æ™‚åˆ»ã‚’å–å¾—
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    
    # è¿½è¨˜å†…å®¹ã‚’æº–å‚™ï¼ˆæ”¹è¡Œã‚’å«ã‚€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ï¼‰
    APPEND_CONTENT="

---
## ğŸ“ è¿½è¨˜ ($TIMESTAMP)

$CONTENT
"
    
    # Canvasç·¨é›†APIå‘¼ã³å‡ºã—ç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æº–å‚™
    # URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ãªãŸã‚curlã§ç›´æ¥POST
    API_RESPONSE=$(curl -s -X POST \
      -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
      -H "Content-Type: application/x-www-form-urlencoded" \
      --data-urlencode "canvas_id=$CANVAS_ID" \
      --data-urlencode "changes=[{\"operation\": \"insert_at_end\", \"document_content\": {\"type\": \"markdown\", \"markdown\": \"$APPEND_CONTENT\"}}]" \
      "https://slack.com/api/canvases.edit")
    
    API_OK=$(echo "$API_RESPONSE" | jq -r '.ok' 2>/dev/null)
    
    if [ "$API_OK" = "true" ]; then
      echo "Canvaså†…å®¹ã‚’è¿½è¨˜ã—ã¾ã—ãŸ"
      echo "çŸ¥è­˜ã‚’Canvasã«ä¿å­˜å®Œäº†: $CANVAS_ID"
    else
      echo "Error: Canvasè¿½è¨˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
      echo "$API_RESPONSE" | jq '.' 2>/dev/null
      exit 1
    fi
    ;;
    
  help)
    echo "SpikyBot Memory Operations - Canvas Knowledge Persistence"
    echo ""
    echo "Usage: sb-memory <command> [options]"
    echo ""
    echo "Commands:"
    echo "  list [search]                  - List/search Slack Canvas knowledge base"
    echo "  view <canvas_id>               - View Canvas content"
    echo "  save <canvas_id> 'content'     - Save knowledge to Canvas"
    echo ""
    echo "Examples:"
    echo "  sb-memory list"
    echo "  sb-memory list 'SpikyBot/all'"
    echo "  sb-memory view F1234567890"
    echo "  sb-memory save F1234567890 '## Bug Fix\\n- Issue #123ã‚’ä¿®æ­£'"
    echo ""
    echo "Note: saveã¯'SpikyBot/'ã¾ãŸã¯'SpikyBot_'ã§å§‹ã¾ã‚‹Canvasåã®ã¿è¨±å¯"
    echo "Note: å…¨ã¦ã®çŸ¥è­˜ã¯Slack Canvasã«æ°¸ç¶šåŒ–ã•ã‚Œã¾ã™"
    ;;
    
  *)
    echo "Unknown command: $SUBCOMMAND"
    echo "Run 'sb-memory help' for usage"
    exit 1
    ;;
esac